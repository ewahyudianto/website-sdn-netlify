<script>
    
    // ⬇️ PERUBAHAN: URL API sekarang adalah proxy lokal ⬇️
    const WEB_APP_URL = "/api"; 
    
    // ⬇️ PENTING: GANTI DENGAN URL ADMIN ANDA ⬇️
    const ADMIN_PANEL_URL = "https://script.google.com/macros/s/AKfycbwGtCKXSm-VlU8Ml-512ErKvhqUDFbgtLz1eLcWrpZrZhrKPsvquVxcTiM0P3XbPDI/exec?page=admin"; 


    /* ============================================================
        API HELPER (MENGGUNAKAN FETCH KE PROXY)
        ============================================================ */
    function api(method, args) {
      return new Promise(async (resolve, reject) => {
        const isReadOperation = method.startsWith('list') || method.startsWith('get');
        
        let url = WEB_APP_URL;
        let options = {
          method: 'GET',
        };

        try {
          if (isReadOperation) {
            // --- Logika untuk GET ---
            const params = new URLSearchParams();
            params.append('action', method);
            if (args && args.length > 0) {
              params.append('id', args[0]); 
            }
            url = `${WEB_APP_URL}?${params.toString()}`;
            
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            
            const data = await response.json(); // Proxy mengirim JSON murni

            if (data.success === false) {
              throw new Error(data.error);
            }
            resolve(data.data); // Kirim datanya

          } else {
            // --- Logika untuk POST ---
            options.method = 'POST';
            
            let payload = { action: method };
            if (method === 'addLike' || method === 'removeLike') {
              payload.itemId = args[0];
            } else if (method === 'addComment') {
              payload.data = args[0]; // { itemId, userName, commentText }
            } else if (method === 'deleteComment') {
              payload.commentId = args[0];
            }
            
            options.body = JSON.stringify(payload);
            
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            
            const data = await response.json();
            
            if (data.success === false) {
              throw new Error(data.error);
            }
            resolve(data.data); // Kirim datanya
          }
        } catch (error) {
          console.error(`API Error (${method}):`, error.message);
          reject(error);
        }
      });
    }

    /* ============================================================
        ROUTER & NAVIGASI WEBSITE SEKOLAH
        ============================================================ */

    async function navigateTo(page) {
      page = page || 'home';
      history.pushState({ page }, "", "#" + page);
      await renderPage(page);
      const mainPage = page.split('/')[0];
      setActiveMenu(mainPage);
    }

    window.addEventListener("popstate", e => {
      const path = (e.state && e.state.page) || window.location.hash.replace("#", "") || "home";
      renderPage(path);
      const mainPage = path.split('/')[0];
      setActiveMenu(mainPage);
    });

    function setActiveMenu(page) {
      document.querySelectorAll(".nav-link").forEach(link => {
        if (link.getAttribute("data-page") === page) {
          link.classList.add("active");
        } else {
          link.classList.remove("active");
        }
      });
    }

    function goAdmin(event) {
      event.preventDefault(); // Mencegah link '#'
      if (ADMIN_PANEL_URL.startsWith("GANTI_DENGAN")) {
        alert("Harap update ADMIN_PANEL_URL di dalam kode index.html!");
        return;
      }
      window.open(ADMIN_PANEL_URL, '_blank');
    }

    /* ============================================================
    EVENT INIT (Digabung)
    ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  // Cek jika URL Admin belum diisi (cek ini boleh tetap ada)
  if (ADMIN_PANEL_URL.startsWith("GANTI_DENGAN")) {
      alert("Peringatan: URL Admin di file index.html belum diatur.");
  }
  
  // Inisialisasi Router
  let path = "";

  // 1. Cek HASH dulu (untuk klik internal #blog)
  path = window.location.hash.replace("#", "");

  // 2. Jika HASH kosong, cek PATHNAME (untuk link langsung /blog)
  if (!path) {
    path = window.location.pathname.replace(/^\/|\/$/g, ""); // Hapus / di awal dan akhir
  }
  
  // 3. Jika semua kosong, set ke 'home'
  if (!path || path === 'index.html' || path === '/') {
    path = 'home';
  }
  
  // 4. Sinkronkan URL (ubah /blog jadi #blog)
  if (window.location.hash.replace("#", "") !== path) {
    history.replaceState({ page: path }, "", "#" + path);
  }

  renderPage(path);
  const mainPage = path.split('/')[0];
  setActiveMenu(mainPage);

  // Inisialisasi Klik Navbar
  document.querySelectorAll("a[data-page]").forEach(el => {
    el.addEventListener("click", e => {
      e.preventDefault();
      const page = el.getAttribute("data-page");
      navigateTo(page);
    });
  });
  
  // Inisialisasi Tahun di Footer
  const yearEl = document.getElementById('year');
  if (yearEl) {
      yearEl.innerText = new Date().getFullYear();
  }
});

    /* ============================================================
        PRELOADER CONTROL
        ============================================================ */
    window.addEventListener("load", () => {
      hidePreloader();
    });

    function showPreloader() {
      const loader = document.getElementById("preloader");
      if (loader) {
        loader.style.display = "flex";
        loader.classList.remove("fade-out");
      }
    }

    function hidePreloader() {
      const loader = document.getElementById("preloader");
      if (loader) {
        loader.classList.add("fade-out");
        setTimeout(() => loader.style.display = "none", 600);
      }
    }
    
    /* ============================================================
        HELPER FUNCTIONS (Escape, Strip, Format Tanggal)
        ============================================================ */
    function escapeHtml(text) {
      if (typeof text !== 'string') return "";
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    function stripHtml(html) {
      let doc = new DOMParser().parseFromString(html, 'text/html');
      return doc.body.textContent || "";
    }

    function formatTanggal(dateString) {
      if (!dateString) return "";
      return new Date(dateString).toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) + " WIB";
    }


    /* ============================================================
        RENDER PAGE UTAMA (SPA ROUTER)
        ============================================================ */
    async function renderPage(path) {
      const container = document.getElementById('app');

      const pathSegments = path.split('/');
      const page = pathSegments[0] || 'home';
      const id = pathSegments[1];

      container.classList.add("fade-out");
      showPreloader();
      await new Promise(res => setTimeout(res, 300));

      // 2. Routing Halaman Detail
      try {
          if (id) {
            if (page === 'blog') {
              await openBlog(id);
            } else if (page === 'announcement') {
              await openAnnouncement(id);
            } 
            else if (page === 'kegiatan') {
              await openKegiatan(id);
            }
            else {
              container.innerHTML = `<h2 class="text-center mt-5">Halaman tidak ditemukan</h2>`;
            }
          } else {
            // 3. Routing Halaman List
            if (page === 'home' || page === '') { // <-- Tangani string kosong
              container.innerHTML = renderHomeSkeleton();
              requestAnimationFrame(() => {
                refreshAnnouncement(); 
                renderHomeData(); 
              });
            }
            else if (page === 'about') {
              container.innerHTML = `<h2 class="text-center mt-5">Halaman tidak ditemukan</h2>`;
            }
            else if (page === 'blog') {
              await renderBlogPageList();
            }
            else if (page === 'gallery') {
              await renderGalleryPageList();
            }
            else if (page === 'kegiatan') {
              await renderKegiatanPageList();
            }
            else if (page === 'announcement') {
              await renderAnnouncementPageList();
            }
            else {
              container.innerHTML = `<h2>Halaman tidak ditemukan</h2>`;
            }
          }
      } catch (error) {
          console.error("Gagal merender halaman:", error);
          container.innerHTML = `<div class="alert alert-danger">Gagal memuat konten. Coba refresh halaman. Error: ${error.message}</div>`;
      } finally {
          container.classList.remove("fade-out");
          hidePreloader();
      }
    }
    
    // ===================== BLOG PAGE (LIST) =====================
    async function renderBlogPageList() {
        const container = document.getElementById('app');
        container.innerHTML = `
          <h2 class="section-title"><i class="bi bi-journal-text me-1"></i>Blog Sekolah</h2>
          <div id="blogList" class="row g-3"></div>
          <div id="blogPagination" class="pagination-wrapper mt-4"></div>
        `;
        const blogs = (await api('listBlog', [])).filter(b => b.published); 
        const list = document.getElementById('blogList');
        const paginationEl = document.getElementById('blogPagination');
        if (!blogs || !blogs.length) {
          list.innerHTML = '<div class="col-12 text-center text-muted">Belum ada artikel.</div>';
          return;
        }
        
        let currentPage = 1; 
        const itemsPerPage = 6; 
        const totalPages = Math.ceil(blogs.length / itemsPerPage);
        
        const renderBlogPage = (pageNum) => {
          list.innerHTML = ''; 
          const start = (pageNum - 1) * itemsPerPage; 
          const end = start + itemsPerPage; 
          const items = blogs.slice(start, end);
          items.forEach(item => {
            const col = document.createElement('div'); col.className = 'col-12 col-sm-6 col-md-4';
            col.innerHTML = `
              <div class="card card-overdrive h-100 shadow-sm" style="cursor: pointer;" onclick="navigateTo('blog/${item.id}')">
                <img src="${item.coverUrl || 'https://picsum.photos/600/300'}" class="card-img-top" alt="${escapeHtml(item.title)}">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title h6 fw-bold">${escapeHtml(item.title)}</h5>
                  <p class="card-text text-muted small mb-2">${new Date(item.date + 'T00:00:00').toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                  <p class="card-text flex-grow-1 small">${escapeHtml((item.excerpt || stripHtml(item.content)).substring(0, 100))}...</p>
                  <span class="btn btn-primary mt-auto align-self-start">Baca Selengkapnya</span>
                </div>
              </div>`;
            list.appendChild(col);
          });
        };
        
        const update = () => { 
          renderBlogPage(currentPage); 
          renderPagination(paginationEl, totalPages, currentPage, (page) => { currentPage = page; update(); }); 
          window.scrollTo({ top: 0, behavior: 'smooth' }); 
        };
        
        update();
    }

    // ===================== GALLERY PAGE (LIST) =====================
    async function renderGalleryPageList() {
        const container = document.getElementById('app');
        container.innerHTML = `
          <h2 class="section-title"><i class="bi bi-images me-1"></i>Gallery Kegiatan</h2>
          <div id="galleryGrid" class="row g-3"></div>
          <div id="galleryPagination" class="pagination-wrapper mt-4"></div>
        `;
        
        const galleryItems = (await api('listGallery', [])).filter(g => g.visible).sort((a, b) => new Date(b.date) - new Date(a.date));
        const grid = document.getElementById('galleryGrid');
        const paginationEl = document.getElementById('galleryPagination');
        if (!galleryItems || !galleryItems.length) {
          grid.innerHTML = '<div class="col-12 text-center text-muted">Belum ada foto di gallery.</div>';
          return;
        }
        
        let currentPage = 1; 
        const itemsPerPage = 6; 
        const totalPages = Math.ceil(galleryItems.length / itemsPerPage);
        
        const renderGalleryPage = (pageNum) => {
          grid.innerHTML = ''; 
          const start = (pageNum - 1) * itemsPerPage; 
          const end = start + itemsPerPage; 
          const items = galleryItems.slice(start, end);
          items.forEach(item => {
            const col = document.createElement('div'); col.className = 'col-12 col-sm-6 col-md-4';
            col.innerHTML = `
              <div class="card card-overdrive h-100 shadow-sm border-0 gallery-item"
                   style="cursor: pointer;"
                   data-url="${item.imageUrl}" 
                   data-title="${escapeHtml(item.title)}">
                <img src="${item.imageUrl}" alt="${escapeHtml(item.title)}" class="card-img-top rounded">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title h6 fw-bold">${escapeHtml(item.title || 'Tanpa Judul')}</h5>
                  <p class="card-text text-muted small mb-2">${new Date(item.date + 'T00:00:00').toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                  <p class="card-text flex-grow-1 small">${escapeHtml(item.caption || '')}</p>
                </div>
              </div>`;
            grid.appendChild(col);
          });

          grid.querySelectorAll('.gallery-item').forEach(card => {
            card.addEventListener('click', () => {
              const imgUrl = card.getAttribute('data-url');
              openImageModal(imgUrl, card.getAttribute('data-title'));
            });
          });
        };
        
        const update = () => { 
          renderGalleryPage(currentPage); 
          renderPagination(paginationEl, totalPages, currentPage, (page) => { currentPage = page; update(); }); 
          window.scrollTo({ top: 0, behavior: 'smooth' }); 
        };

        update();
    }

    // ===================== KEGIATAN PAGE (LIST) ===================== 
    async function renderKegiatanPageList() {
        const container = document.getElementById('app');
        container.innerHTML = `
          <h2 class="section-title"><i class="bi bi-play-btn-fill me-2"></i>Kegiatan Sekolah</h2>
          <div id="kegiatanGrid" class="row g-3"></div>
          <div id="kegiatanPagination" class="pagination-wrapper mt-4"></div>
        `;
        
        const [kegiatanItemsRaw, allInteractions] = await Promise.all([
           api('listKegiatan', []),
           api('getAllInteractions', []) 
        ]);

        const kegiatanItems = kegiatanItemsRaw
          .filter(k => k.visible)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        const grid = document.getElementById('kegiatanGrid');
        const paginationEl = document.getElementById('kegiatanPagination');

        if (!kegiatanItems || !kegiatanItems.length) {
          grid.innerHTML = '<div class="col-12 text-center text-muted">Belum ada kegiatan yang ditampilkan.</div>';
          return;
        }

        let currentPage = 1;
        const itemsPerPage = 6;
        const totalPages = Math.ceil(kegiatanItems.length / itemsPerPage);

        const renderKegiatanPage = (pageNum) => {
          grid.innerHTML = '';
          const start = (pageNum - 1) * itemsPerPage;
          const end = start + itemsPerPage;
          const items = kegiatanItems.slice(start, end);

          items.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-12 col-sm-6 col-md-4';
            
            const mediaContent = renderMedia(item, true); 

            const likeCount = allInteractions.counts[item.id] || 0;
            const userHasLiked = allInteractions.userLikes.includes(item.id);
            const likeBtnClass = userHasLiked ? 'liked' : 'not-liked';
            const likeIcon = userHasLiked ? 'bi-heart-fill' : 'bi-heart';

            const likeButtonHtml = `
              <button id="like-btn-${item.id}" 
                      class="card-like-button ${likeBtnClass}" 
                      onclick="handleCardLikeClick(event, '${item.id}')">
                <i class="bi ${likeIcon}"></i>
                <span id="like-count-${item.id}">${likeCount}</span>
              </button>
            `;

            col.innerHTML = `
              <div class="card card-overdrive h-100 shadow-sm border-0">
                ${likeButtonHtml} 
                ${mediaContent}
                <div class="card-body d-flex flex-column" style="cursor: pointer;" onclick="navigateTo('kegiatan/${item.id}')">
                  <h5 class="card-title h6 fw-bold">${escapeHtml(item.title || 'Tanpa Judul')}</h5>
                  <p class="card-text text-muted small mb-2">
                    ${new Date(item.date + 'T00:00:00').toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}
                  </p>
                  <p class="card-text flex-grow-1 small">${escapeHtml((item.description || '').substring(0, 100))}...</p>
                  <span class="btn btn-primary btn-sm mt-2 align-self-start">Lihat Detail</span>
                </div>
              </div>
            `;
            grid.appendChild(col);
          });
        };

        const update = () => {
          renderKegiatanPage(currentPage);
          renderPagination(paginationEl, totalPages, currentPage, (page) => {
            currentPage = page;
            update();
          });
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        update();
    }


    // ===================== ANNOUNCEMENT PAGE (LIST) =====================
    async function renderAnnouncementPageList() {
        const container = document.getElementById('app');
        container.innerHTML = `
          <h2 class="section-title"><i class="bi bi-megaphone me-1"></i>Semua Pengumuman</h2>
          <div id="announcementList" class="list-group"></div>
          <div id="announcementPagination" class="pagination-wrapper mt-4"></div>
        `;
        const announcements = (await api('listAnnouncement', [])).reverse();
        const list = document.getElementById('announcementList');
        const paginationEl = document.getElementById('announcementPagination');
        if (!announcements || !announcements.length) {
          list.innerHTML = '<div class="col-12 text-center text-muted">Belum ada pengumuman.</div>';
          return;
        }

        let currentPage = 1; 
        const itemsPerPage = 5; 
        const totalPages = Math.ceil(announcements.length / itemsPerPage);
        
        const renderAnnouncementPage = (pageNum) => {
          list.innerHTML = ''; 
          const start = (pageNum - 1) * itemsPerPage; 
          const end = start + itemsPerPage; 
          const items = announcements.slice(start, end);
          items.forEach(a => {
            const itemEl = document.createElement('a');
            itemEl.href = `#announcement/${a.id}`;
            itemEl.className = 'list-group-item list-group-item-action';
            itemEl.onclick = (e) => { e.preventDefault(); navigateTo(`announcement/${a.id}`); };
            itemEl.innerHTML = `
              <div class="d-flex w-100 justify-content-between">
                <h5 class="card-title h6 fw-bold">${escapeHtml(a.title)}</h5>
                <small class="card-text text-muted small mb-2">${new Date(a.date + 'T00:00:00').toLocaleDateString('id-ID')}</small>
              </div>
              <p class="card-text flex-grow-1 small">${escapeHtml(stripHtml(a.message).substring(0, 150))}...</p>`;
            list.appendChild(itemEl);
          });
        };
        
        const update = () => { 
          renderAnnouncementPage(currentPage); 
          renderPagination(paginationEl, totalPages, currentPage, (page) => { currentPage = page; update(); }); 
          window.scrollTo({ top: 0, behavior: 'smooth' }); 
        };
        update();
    }


    /* ============================================================
        PAGINATION HELPER
        ============================================================ */
    function renderPagination(el, totalPages, currentPage, onPageClick) {
      el.innerHTML = '';
      if (totalPages <= 1) return;
      const createBtn = (text, pageNum, disabled = false, active = false) => {
        const btn = document.createElement('button');
        btn.innerHTML = text;
        btn.className = `btn-pagination ${active ? 'active' : ''}`;
        btn.disabled = disabled;
        btn.onclick = () => onPageClick(pageNum);
        el.appendChild(btn);
      };
      createBtn('«', currentPage - 1, currentPage === 1);
      for (let i = 1; i <= totalPages; i++) {
        const isCurrent = i === currentPage;
        if (totalPages > 7 && Math.abs(currentPage - i) > 2 && i !== 1 && i !== totalPages) {
          if (!el.querySelector('.ellipsis')) {
            const span = document.createElement('span');
            span.className = 'ellipsis px-2';
            span.textContent = '...';
            el.appendChild(span);
          }
          continue;
        }
        createBtn(i, i, false, isCurrent);
      }
      createBtn('»', currentPage + 1, currentPage === totalPages);
    }

    /* ============================================================
        RENDER HALAMAN DETAIL
        ============================================================ */

    // ============= DETAIL: ANNOUNCEMENT =============
    async function openAnnouncement(id) {
      const container = document.getElementById('app');
      showPreloader();
      const a = await api('getAnnouncement', [id]);
      if (!a) { container.innerHTML = '<div>Pengumuman tidak ditemukan.</div>'; hidePreloader(); return; }
      
      container.innerHTML = `
        <div class="mb-4"><button class="btn btn-outline-primary" onclick="navigateTo('announcement')"><i class="bi bi-arrow-left me-1"></i> Kembali ke daftar</button></div>
        <div class="card card-overdrive p-4">
          <h2>${escapeHtml(a.title)}</h2>
          <p class="text-muted">${new Date(a.date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <hr>
          <div class="mt-3">${a.message}</div>
        </div>
      `;
      history.replaceState({}, "", "#announcement/" + id);
      hidePreloader();
    }
    async function renderOpenAnnouncement(id){ await openAnnouncement(id); }

    // ============= DETAIL: BLOG =============
    async function openBlog(id) {
      const container = document.getElementById('app');
      showPreloader();
      const b = await api('getBlog', [id]);
      if (!b) { container.innerHTML = '<div>Artikel tidak ditemukan.</div>'; hidePreloader(); return; }

      container.innerHTML = `
        <div class="mb-4"><button class="btn btn-outline-primary" onclick="navigateTo('blog')"><i class="bi bi-arrow-left me-1"></i> Kembali ke blog</button></div>
        <div class="card card-overdrive">
          <img src="${b.coverUrl||'https://picsum.photos/800/400'}" class="card-img-top" style="max-height:400px;object-fit:cover;">
          <div class="card-body p-4">
            <h1>${escapeHtml(b.title)}</h1>
            <p class="text-muted">${new Date(b.date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} • Oleh ${escapeHtml(b.author||'Admin')}</p>
            <hr>
            <div class="mt-3">${b.content}</div>
          </div>
        </div>
      `;
      history.replaceState({}, "", "#blog/" + id);
      hidePreloader();
    }
    async function renderBlogDetail(id){ await openBlog(id); }

    // ============= DETAIL KEGIATAN ⬇️ =============
    async function openKegiatan(id) {
      const container = document.getElementById('app');
      showPreloader();
      
      try {
        const [item, interactions] = await Promise.all([
          api('getKegiatan', [id]),
          api('getInteractions', [id]) 
        ]);

        if (!item) {
          container.innerHTML = '<div>Kegiatan tidak ditemukan.</div>';
          hidePreloader();
          return;
        }

        const mediaContent = renderMedia(item, false); 
        const likeButtonClass = interactions.userHasLiked ? 'liked' : 'not-liked';
        const likeIcon = interactions.userHasLiked ? 'bi-heart-fill' : 'bi-heart';
        
        const likeButton = `
          <button id="likeBtn" class="btn like-button ${likeButtonClass}" onclick="handleLikeClick(event, '${id}')">
            <i class="bi ${likeIcon}"></i>
            <span id="likeCount">${interactions.likeCount}</span> Suka
          </button>
        `;

        const commentForm = `
          <div class="comment-form mt-4">
            <h5 class="h6 fw-bold">Beri Komentar</h5>
            <div class="mb-2">
              <input type="text" id="commentName" class="form-control" placeholder="Nama Anda" required>
            </div>
            <div class="mb-2">
              <textarea id="commentText" class="form-control" rows="3" placeholder="Tulis komentar Anda..." required></textarea>
            </div>
            <button class="btn btn-primary" onclick="handleCommentSubmit(event, '${id}')">Kirim Komentar</button>
          </div>
        `;

        let commentListHtml = '<div class="text-muted small mt-3">Belum ada komentar.</div>';
        if (interactions.comments && interactions.comments.length > 0) {
          commentListHtml = interactions.comments.map(c => `
            <li class="comment-item" id="comment-${c.commentId}">
              <div class="comment-header">
                <span class="comment-user">${escapeHtml(c.userName)}</span>
                <span class="comment-date">${formatTanggal(c.date)}</span>
              </div>
              <p class="comment-body">${escapeHtml(c.commentText)}</p>
              ${c.isOwner ? `<button class="comment-delete" onclick="handleDeleteComment(event, '${c.commentId}', '${id}')">Hapus</button>` : ''}
            </li>
          `).join('');
        }

        container.innerHTML = `
          <div class="mb-4">
            <button class="btn btn-outline-primary" onclick="navigateTo('kegiatan')">
              <i class="bi bi-arrow-left me-1"></i> Kembali ke daftar
            </button>
          </div>
          
          <div class="card card-overdrive">
            ${mediaContent}
            <div class="card-body p-4">
              <h1 class="h3">${escapeHtml(item.title)}</h1>
              <p class="text-muted small">
                <i class="bi bi-calendar-event"></i> ${new Date(item.date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                ${item.location ? `• <i class="bi bi-geo-alt-fill"></i> ${escapeHtml(item.location)}` : ''}
              </p>
              <hr>
              
              <div class="mt-3 mb-4">
                ${(item.description || '').replace(/\n/g, '<br>')}
              </div>

              <div class="interaction-wrapper">
                ${likeButton}
              </div>

              <div class="comment-section">
                <hr>
                <h4 class="h5 fw-bold">Komentar (<span id="commentCount">${interactions.comments.length}</span>)</h4>
                <ul class="comment-list" id="commentList">
                  ${commentListHtml}
                </ul>
                ${commentForm}
              </div>
            </div>
          </div>
        `;

        history.replaceState({}, "", "#kegiatan/" + id);

      } catch (error) {
        console.error("Gagal membuka kegiatan:", error);
        container.innerHTML = '<div>Gagal memuat data kegiatan.</div>';
      } finally {
        hidePreloader();
      }
    }

    // ============= HELPER RENDER MEDIA ⬇️ =============
    function renderMedia(item, isCard = false) {
      const url = item.imageUrl || '';
      
      if (url.includes('/embed/') || url.includes('/preview')) {
        return `
          <div class="ratio ratio-16x9">
            <iframe src="${url}" allowfullscreen class="${isCard ? 'card-img-top' : ''}"></iframe>
          </div>
        `;
      }

      if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i) || url.includes('thumbnail?id=')) {
        const style = isCard 
          ? 'class="card-img-top"' 
          : 'class="img-fluid rounded-top" style="max-height: 500px; width: 100%; object-fit: cover;"';
        return `<img src="${url}" alt="${escapeHtml(item.title)}" ${style}>`;
      }

      const style = isCard ? 'class="card-img-top"' : '';
      return `
        <div ${style} class="d-flex flex-column align-items-center justify-content-center text-secondary bg-light" style="min-height: 200px; border-bottom: 1px solid #eee;">
          <i class="bi bi-camera-reels" style="font-size: 3rem;"></i>
          <small class="mt-2">Media tidak tersedia</small>
        </div>
      `;
    }

    // ============= HANDLER LIKE/COMMENT ⬇️ =============
    async function handleLikeClick(event, itemId) {
      const likeBtn = event.currentTarget;
      const likeCountEl = document.getElementById('likeCount');
      const icon = likeBtn.querySelector('i');

      likeBtn.disabled = true;

      try {
        if (likeBtn.classList.contains('not-liked')) {
          await api('addLike', [itemId]);
          likeBtn.classList.replace('not-liked', 'liked');
          icon.classList.replace('bi-heart', 'bi-heart-fill');
          likeCountEl.innerText = parseInt(likeCountEl.innerText) + 1;
        } else {
          await api('removeLike', [itemId]);
          likeBtn.classList.replace('liked', 'not-liked');
          icon.classList.replace('bi-heart-fill', 'bi-heart');
          likeCountEl.innerText = parseInt(likeCountEl.innerText) - 1;
        }
      } catch (e) {
        alert("Gagal melakukan aksi: " + e.message);
      } finally {
        likeBtn.disabled = false;
      }
    }
    
    async function handleCardLikeClick(event, itemId) {
      event.stopPropagation(); 

      const likeBtn = document.getElementById(`like-btn-${itemId}`);
      const likeCountEl = document.getElementById(`like-count-${itemId}`);
      const icon = likeBtn.querySelector('i');
      
      likeBtn.disabled = true;
      
      try {
        if (likeBtn.classList.contains('not-liked')) {
          await api('addLike', [itemId]);
          likeBtn.classList.replace('not-liked', 'liked');
          icon.classList.replace('bi-heart', 'bi-heart-fill');
          likeCountEl.innerText = parseInt(likeCountEl.innerText) + 1;
        } else {
          await api('removeLike', [itemId]);
          likeBtn.classList.replace('liked', 'not-liked');
          icon.classList.replace('bi-heart-fill', 'bi-heart');
          likeCountEl.innerText = parseInt(likeCountEl.innerText) - 1;
        }
      } catch (e) {
        alert("Gagal melakukan aksi: " + e.message);
      } finally {
        likeBtn.disabled = false;
      }
    }


    async function handleCommentSubmit(event, itemId) {
      const nameEl = document.getElementById('commentName');
      const textEl = document.getElementById('commentText');
      const listEl = document.getElementById('commentList');
      const countEl = document.getElementById('commentCount');

      const userName = nameEl.value.trim();
      const commentText = textEl.value.trim();

      if (!userName || !commentText) {
        alert("Nama dan komentar tidak boleh kosong.");
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = "Mengirim...";

      try {
        const result = await api('addComment', [{ itemId, userName, commentText }]);

        if (result && result.comment) {
          const c = result.comment;
          const newCommentHtml = `
            <li class="comment-item" id="comment-${c.commentId}">
              <div class="comment-header">
                <span class="comment-user">${escapeHtml(c.userName)}</span>
                <span class="comment-date">${formatTanggal(c.date)}</span>
              </div>
              <p class="comment-body">${escapeHtml(c.commentText)}</p>
              ${c.isOwner ? `<button class="comment-delete" onclick="handleDeleteComment(event, '${c.commentId}', '${itemId}')">Hapus</button>` : ''}
            </li>
          `;

          if (listEl.children.length === 1 && !listEl.children[0].classList.contains('comment-item')) {
            listEl.innerHTML = '';
          }

          listEl.insertAdjacentHTML('beforeend', newCommentHtml);
          textEl.value = ''; // Kosongkan text area
          countEl.innerText = parseInt(countEl.innerText) + 1;

        } else {
          throw new Error(result.error || "Gagal mengirim komentar.");
        }
      } catch (e) {
        alert("Gagal mengirim komentar: " + e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = "Kirim Komentar";
      }
    }

    async function handleDeleteComment(event, commentId, itemId) {
      if (!confirm("Apakah Anda yakin ingin menghapus komentar ini?")) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerText = "Menghapus...";

      try {
        const result = await api('deleteComment', [commentId]);
        if (result.success) { // Perhatikan: API delete saya sebelumnya mungkin hanya mengembalikan {success: true}
          document.getElementById(`comment-${commentId}`).remove();

          const countEl = document.getElementById('commentCount');
          const newCount = parseInt(countEl.innerText) - 1;
          countEl.innerText = newCount;

          if (newCount === 0) {
            document.getElementById('commentList').innerHTML = '<div class="text-muted small mt-3">Belum ada komentar.</div>';
          }
        } else {
          throw new Error(result.error || "Gagal menghapus.");
        }
      } catch (e) {
        alert("Gagal menghapus komentar: " + e.message);
        btn.disabled = false;
        btn.innerText = "Hapus";
      }
    }


    // ============= MODAL GAMBAR =============
    function openImageModal(url, title = '') {
      if (!url) {
        console.error("URL tidak valid atau kosong.");
        return;
      }

      const modalId = 'imageModal';
      const oldModal = document.getElementById(modalId);
      if (oldModal) oldModal.remove();

      const modalHtml = `
      <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0 shadow-none">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3 text-white" data-bs-dismiss="modal" aria-label="Close"></button>
      <img src="${url}" alt="${escapeHtml(title)}" class="img-fluid rounded shadow-lg">
        </div>
        </div>
      </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modalElement = document.getElementById(modalId);
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
      modalElement.addEventListener('hidden.bs.modal', () => modalElement.remove());
    }


    // ============= FUNGSI HOME =============
    function renderHomeSkeleton() {
      return `
        <div class="overdrive-hero mb-5">
          <div class="row align-items-center">
            <div class="col-md-7 text-white">
              <h1 class="hero-title">Selamat datang di sekolah kita</h1>
              <p class="lead">Tempat belajar, berkarya, dan tumbuh bersama.</p>
              <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="navigateTo('blog')">Baca Blog</button>
                <button class="btn btn-outline-light" onclick="navigateTo('gallery')">Lihat Gallery</button>
              </div>
            </div>
          </div>
        </div>

        <div id="announcementCard" class="alert alert-warning shadow-sm p-4 mb-4 rounded-3 position-relative">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-2 fw-bold text-danger">
                <i class="bi bi-megaphone-fill me-2"></i> Pengumuman Penting
              </h5>
              <p id="announcementText" class="mb-0 small text-dark">Memuat pengumuman...</p>
            </div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-dark" onclick="refreshAnnouncement()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>

        <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="section-title mb-0">
                <i class="bi bi-calendar3"></i> Agenda Sekolah
            </h4>
            <a href="#kegiatan" onclick="navigateTo('kegiatan')" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
        </div>

        <div class="card calendar-card p-4 bg-light shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h5 id="calendarTitle" class="fw-semibold text-black mb-2 mb-md-0"></h5>
                <div class="d-flex align-items-center gap-2">
                    <button id="prevBtn" class="btn btn-sm"><i class="bi bi-chevron-left"></i></button>
                    <button id="nextBtn" class="btn btn-sm"><i class="bi bi-chevron-right"></i></button>
                    <button id="todayBtn" class="btn btn-sm">Hari Ini</button>
                </div>
            </div>
            <div id="agendaCalendar"></div>
        </div>
    </div>

    <div class="modal fade" id="agendaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-calendar-event me-2"></i> Detail Agenda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="agendaModalBody">
                    <p>Memuat...</p>
                </div>
            </div>
        </div>
    </div>

        <div class="mb-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="section-title mb-0"><i class="bi bi-images"></i> Gallery Terbaru</h4>
            <a href="#gallery" onclick="navigateTo('gallery')" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
          </div>
          <div id="homeGalleryCarousel" class="carousel slide shadow rounded overflow-hidden" data-bs-ride="carousel">
            <div class="carousel-inner" id="homeGalleryCarouselInner">
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#homeGalleryCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Sebelumnya</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#homeGalleryCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Berikutnya</span>
            </button>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="section-title mb-0"><i class="bi bi-newspaper"></i> Artikel Terbaru</h4>
          <a href="#blog" onclick="navigateTo('blog')" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
        </div>
        <div id="homeBlogs" class="row g-4"></div>
      `;
    }

    async function renderHomeData() {
      try {
        const [blogs, gallery, kegiatan] = await Promise.all([
          api('listBlog', []),
          api('listGallery', []),
          api('listKegiatan', []),
        ]);

        // ====== RENDER GALLERY CAROUSEL ======
        const galleryContainer = document.getElementById('homeGalleryCarouselInner');
        if (galleryContainer) {
          galleryContainer.innerHTML = '';
          const visibleGallery = gallery
            .filter(g => g.visible)
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 6);
          if (visibleGallery.length === 0) {
            galleryContainer.innerHTML = `<div class="text-center p-5 text-muted">Belum ada foto di galeri.</div>`;
          } else {
            visibleGallery.forEach((item, i) => {
              const active = i === 0 ? 'active' : '';
              galleryContainer.innerHTML += `
                <div class="carousel-item ${active}">
                  <img src="${item.imageUrl}" class="d-block w-100" style="object-fit:cover; height:400px;" alt="${escapeHtml(item.title)}">
                  <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-2">
                    <h5 class="mb-1">${escapeHtml(item.title || 'Tanpa Judul')}</h5>
                    ${item.caption ? `<p class="small mb-0">${escapeHtml(item.caption)}</p>` : ''}
                  </div>
                </div>
              `;
            });
          }
        }

        // ====== RENDER BLOG ======
        const homeBlogsContainer = document.getElementById('homeBlogs');
        if (homeBlogsContainer) {
          homeBlogsContainer.innerHTML = '';
          const visibleBlogs = blogs.filter(b => b.published).slice(0, 2); 
          visibleBlogs.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `
              <div class="card card-overdrive h-100 shadow-sm border-0" style="cursor: pointer;" onclick="navigateTo('blog/${item.id}')">
                <img src="${item.coverUrl || 'https://picsum.photos/600/300'}" class="card-img-top" alt="${escapeHtml(item.title)}">
                <div class="card-body d-flex flex-column">
                  <h5 class="mb-1">${escapeHtml(item.title)}</h5>
                  <p class="small mb-0">
                    ${escapeHtml((item.excerpt || stripHtml(item.content)).substring(0, 80))}...
                  </p>
                  <button class="btn btn-primary btn-sm mt-2 align-self-start" onclick="navigateTo('blog/${item.id}')">Baca</button>
                </div>
              </div>
            `;
            homeBlogsContainer.appendChild(col);
          });
        }

        // ========== AGENDA (FullCalendar) ==========
        const calendarEl = document.getElementById('agendaCalendar');
        if (calendarEl && typeof FullCalendar !== 'undefined') {
          const visibleKegiatan = kegiatan.filter(k => k.visible);
          const events = visibleKegiatan.map(k => ({
            id: k.id,
            title: k.title,
            start: k.date,
            extendedProps: {
              description: k.description,
              imageUrl: k.imageUrl,
              location: k.location
            }
          }));

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'id',
            height: 550,
            events,
            headerToolbar: false,
            eventClick: function (info) {
              const e = info.event.extendedProps;
              const modalBody = document.getElementById('agendaModalBody');
              
              const mediaContent = renderMedia({ imageUrl: e.imageUrl, title: info.event.title }, false);

              modalBody.innerHTML = `
                ${mediaContent}
                <div class="p-3">
                  <h6 class="fw-bold mb-2">${escapeHtml(info.event.title)}</h6>
                  <p class="small text-muted mb-1">
                      <i class="bi bi-calendar-event"></i> 
                      ${new Date(info.event.start + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                  </p>
                  ${e.location ? `<p class="small text-muted mb-2"><i class="bi bi-geo-alt"></i> ${escapeHtml(e.location)}</p>` : ''}
                  <p>${escapeHtml(e.description || 'Tidak ada deskripsi')}</p>
                </div>`;
              
              const modal = new bootstrap.Modal(document.getElementById('agendaModal'));
              modal.show();
            }
          });

          calendar.render();
          const titleEl = document.getElementById('calendarTitle');
          function updateTitle() {
            if (titleEl) titleEl.textContent = calendar.view.title;
          }
          updateTitle();

          document.getElementById('nextBtn').onclick = () => { calendar.next(); updateTitle(); };
          document.getElementById('prevBtn').onclick = () => { calendar.prev(); updateTitle(); };
          document.getElementById('todayBtn').onclick = () => { calendar.today(); updateTitle(); };
        }
      } catch (error) {
        console.error("Gagal memuat data home:", error);
      }
    }

    // ==================== PENGUMUMAN ====================
    async function refreshAnnouncement() {
      const textEl = document.getElementById('announcementText');
      const refreshBtn = document.getElementById('refreshBtn');
      if (!textEl || !refreshBtn) return;

      textEl.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i> Memuat pengumuman...</span>';
      refreshBtn.disabled = true;
      refreshBtn.querySelector('i').classList.add('animate-spin');

      try {
        const announcements = (await api('listAnnouncement', [])).reverse();
        
        if (announcements && announcements.length > 0) {
          
          const latestAnnouncements = announcements.slice(0, 4);

          const html = latestAnnouncements.map(a => {
            
            let displayDate = '';
            if (a.date) {
               displayDate = new Date(a.date + 'T00:00:00').toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              });
            }

            return `
              <div class="mb-2 pb-2 border-bottom">
                <small class="text-muted d-block">${displayDate}</small>
                <strong class="d-block">${escapeHtml(a.title)}</strong>
                <a href="#announcement/${a.id}" 
                   onclick="navigateTo('announcement/${a.id}')" 
                   class="fw-bold">
                   Baca selengkapnya
                </a>
              </div>
            `;
          }).join(''); 

          textEl.innerHTML = html; 
          
        } else {
          textEl.textContent = 'Tidak ada pengumuman terbaru saat ini.';
        }
      } catch (error) {
        console.error(error);
        textEl.innerHTML = '<span class="text-danger">Gagal memuat pengumuman.</span>';
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.querySelector('i').classList.remove('animate-spin');
      }
    }

    // Efek putar ikon refresh
    document.head.insertAdjacentHTML("beforeend", `<style>.animate-spin{animation: spin 1s linear infinite;} @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>`);

  </script>
  </body>
</html>